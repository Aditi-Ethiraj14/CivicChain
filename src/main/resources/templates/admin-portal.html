<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicChain - Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
        }
        .stat-card {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1rem;
        }
        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
        }
        .badge {
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-shield-alt me-2"></i>CivicChain - Admin Portal
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" th:if="${currentUser}">
                    <i class="fas fa-user-shield me-1"></i>
                    <span th:text="${currentUser.username}">Admin</span>
                    <small class="ms-2 opacity-75" th:text="${currentUser.role}">ADMIN</small>
                </span>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 th:text="${totalReports}">0</h3>
                            <p class="mb-0">Total Reports</p>
                        </div>
                        <i class="fas fa-clipboard-list fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 th:text="${pendingReports}">0</h3>
                            <p class="mb-0">Pending</p>
                        </div>
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 th:text="${verifiedReports}">0</h3>
                            <p class="mb-0">Verified</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 th:text="${totalUsers}">0</h3>
                            <p class="mb-0">Total Users</p>
                        </div>
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Actions -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-tasks fa-3x text-danger mb-3"></i>
                        <h5 class="card-title">Manage Reports</h5>
                        <p class="card-text">Review, verify, and manage all submitted reports.</p>
                        <button class="btn btn-danger" onclick="showManageReports()">
                            <i class="fas fa-cog me-1"></i>Manage Reports
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-user-cog fa-3x text-info mb-3"></i>
                        <h5 class="card-title">User Management</h5>
                        <p class="card-text">Manage user accounts, roles, and permissions.</p>
                        <button class="btn btn-info" onclick="showUserManagement()">
                            <i class="fas fa-users me-1"></i>Manage Users
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Analytics</h5>
                        <p class="card-text">View system analytics and reporting statistics.</p>
                        <button class="btn btn-success" onclick="showAnalytics()">
                            <i class="fas fa-chart-line me-1"></i>View Analytics
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Content Section -->
        <div class="row">
            <div class="col-12">
                <!-- Reports Management Section -->
                <div class="card" id="reportsManagement" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks me-2"></i>Reports Management Dashboard
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="showMainDashboard()">Back to Dashboard</button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <canvas id="reportsChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-6">
                                <canvas id="categoryChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Reporter</th>
                                        <th>Status</th>
                                        <th>AI Verified</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div class="card" id="userManagement" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>User Management Dashboard
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="showMainDashboard()">Back to Dashboard</button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-primary">156</h3>
                                        <p>Total Users</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-success">23</h3>
                                        <p>Active Today</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-info">8</h3>
                                        <p>New This Week</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <canvas id="userActivityChart" width="400" height="200"></canvas>
                        <div class="table-responsive mt-4">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Level</th>
                                        <th>XP</th>
                                        <th>Reports</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div class="card" id="analytics" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>System Analytics & Reporting
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="showMainDashboard()">Back to Dashboard</button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>📊 Report Trends (Last 30 Days)</h6>
                                <canvas id="trendsChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h6>🗺️ Geographic Heat Map</h6>
                                <div id="heatMap" style="height: 300px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4); border-radius: 10px; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                                        <i class="fas fa-map-marked-alt fa-3x mb-2"></i>
                                        <h6>Interactive Heat Map</h6>
                                        <small>Hotspots: Downtown (15), Park Area (8), Industrial (12)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <h6>📈 Performance Metrics</h6>
                                <canvas id="performanceChart" width="800" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Default Dashboard -->
        <div class="row" id="mainDashboard">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Recent Reports (Admin View)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${reports.empty}" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No reports submitted yet</p>
                        </div>
                        <div class="table-responsive" th:if="${!reports.empty}">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="report : ${reports}">
                                        <td th:text="${report.title}">Report Title</td>
                                        <td>
                                            <span class="badge bg-secondary" th:text="${report.category}">Category</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning" th:text="${report.status}">Status</span>
                                        </td>
                                        <td th:text="${#temporals.format(report.createdAt, 'MMM dd, yyyy')}">Date</td>
                                        <td>
                                            <form th:action="@{'/admin/approve-report/' + ${report.id}}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-success me-1" 
                                                        onclick="return confirm('Approve this report?')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                            <form th:action="@{'/admin/reject-report/' + ${report.id}}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-danger" 
                                                        onclick="return confirm('Reject this report?')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>Recent Users
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${users.empty}" class="text-center text-muted py-4">
                            <p>No users registered yet</p>
                        </div>
                        <div th:each="user : ${users}" class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="fw-bold" th:text="${user.username}">Username</div>
                                <small class="text-muted" th:text="${user.email}">email@example.com</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary" th:text="${user.role}">Role</span>
                                <br>
                                <small class="text-muted" th:text="'Level ' + ${user.level}">Level 1</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let reportsChart, categoryChart, userActivityChart, trendsChart, performanceChart;
        
        function showManageReports() {
            hideAllSections();
            document.getElementById('reportsManagement').style.display = 'block';
            loadReportsData();
            createReportsCharts();
        }
        
        function showUserManagement() {
            hideAllSections();
            document.getElementById('userManagement').style.display = 'block';
            loadUsersData();
            createUserActivityChart();
        }
        
        function showAnalytics() {
            hideAllSections();
            document.getElementById('analytics').style.display = 'block';
            createAnalyticsCharts();
        }
        
        function showMainDashboard() {
            hideAllSections();
            document.getElementById('mainDashboard').style.display = 'block';
        }
        
        function hideAllSections() {
            document.getElementById('reportsManagement').style.display = 'none';
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('analytics').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'none';
        }
        
        function loadReportsData() {
            const tableBody = document.getElementById('reportsTableBody');
            
            fetch('/api/admin/reports')
                .then(response => response.json())
                .then(data => {
                    if (data.reports) {
                        tableBody.innerHTML = data.reports.map(report => `
                            <tr>
                                <td>${report.id}</td>
                                <td>${report.title}</td>
                                <td><span class="badge bg-secondary">${report.category}</span></td>
                                <td>${report.reporter ? report.reporter.username : 'Unknown'}</td>
                                <td><span class="badge bg-${report.status === 'VERIFIED' ? 'success' : report.status === 'PENDING' ? 'warning' : 'info'}">${report.status}</span></td>
                                <td>${report.aiVerified ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-times-circle text-danger"></i>'}</td>
                                <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                                <td>
                                    ${report.status === 'PENDING' ? `
                                        <button class="btn btn-sm btn-success me-1" onclick="approveReport(${report.id})"><i class="fas fa-check"></i></button>
                                        <button class="btn btn-sm btn-danger me-1" onclick="rejectReport(${report.id})"><i class="fas fa-times"></i></button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-info" onclick="viewReport(${report.id})"><i class="fas fa-eye"></i></button>
                                </td>
                            </tr>
                        `).join('');
                        
                        // Update chart data with real data
                        updateReportsCharts(data);
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No reports found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading reports:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading reports</td></tr>';
                });
        }
        
        function loadUsersData() {
            const tableBody = document.getElementById('usersTableBody');
            
            fetch('/api/admin/users')
                .then(response => response.json())
                .then(data => {
                    if (data.users) {
                        tableBody.innerHTML = data.users.map(user => `
                            <tr id="user-row-${user.id}">
                                <td><strong>${user.username}</strong></td>
                                <td>${user.email}</td>
                                <td><span class="badge bg-${user.role === 'ADMIN' ? 'danger' : 'primary'}">${user.role}</span></td>
                                <td>Level ${user.level}</td>
                                <td>${user.xp} XP</td>
                                <td>${user.reports ? user.reports.length : 0}</td>
                                <td><span class="badge bg-success">ACTIVE</span></td>
                                <td>
                                    ${user.role !== 'ADMIN' ? `
                                        <button class="btn btn-sm btn-primary me-1" onclick="editUser(${user.id}, '${user.username}', '${user.role}', ${user.xp})"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id}, '${user.username}')"><i class="fas fa-trash"></i></button>
                                    ` : '<span class="text-muted">Protected</span>'}
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading users</td></tr>';
                });
        }
        
        function createReportsCharts() {
            // Reports Status Chart
            if (reportsChart) reportsChart.destroy();
            const ctx1 = document.getElementById('reportsChart').getContext('2d');
            reportsChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Verified', 'Pending', 'In Progress', 'Rejected'],
                    datasets: [{
                        data: [45, 23, 12, 8],
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Reports by Status' }
                    }
                }
            });
            
            // Category Distribution Chart
            if (categoryChart) categoryChart.destroy();
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Pothole', 'Streetlight', 'Garbage', 'Traffic', 'Flood', 'Other'],
                    datasets: [{
                        label: 'Reports',
                        data: [18, 12, 15, 8, 5, 10],
                        backgroundColor: '#dc3545'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Reports by Category' }
                    }
                }
            });
        }
        
        function createUserActivityChart() {
            if (userActivityChart) userActivityChart.destroy();
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            userActivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Users',
                        data: [12, 19, 8, 15, 25, 18],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0,123,255,0.1)'
                    }, {
                        label: 'Active Users',
                        data: [45, 52, 48, 61, 78, 83],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40,167,69,0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'User Activity Over Time' }
                    }
                }
            });
        }
        
        function createAnalyticsCharts() {
            // Trends Chart
            if (trendsChart) trendsChart.destroy();
            const ctx1 = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Array.from({length: 30}, (_, i) => `Day ${i+1}`),
                    datasets: [{
                        label: 'Reports Submitted',
                        data: Array.from({length: 30}, () => Math.floor(Math.random() * 10) + 1),
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255,107,107,0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Daily Report Submissions' }
                    }
                }
            });
            
            // Performance Chart
            if (performanceChart) performanceChart.destroy();
            const ctx2 = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Response Time', 'Resolution Rate', 'User Satisfaction', 'AI Accuracy', 'Community Engagement'],
                    datasets: [{
                        label: 'Performance %',
                        data: [85, 92, 78, 88, 95],
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: { display: true, text: 'System Performance Metrics' }
                    }
                }
            });
        }
        
        function approveReport(id) {
            alert(`Report ${id} approved successfully! ✅`);
        }
        
        function rejectReport(id) {
            alert(`Report ${id} rejected. 🚫`);
        }
        
        function viewReport(id) {
            alert(`Viewing detailed report ${id} with photos, location, and AI analysis.`);
        }
        
        function editUser(username) {
            alert(`Editing user: ${username}`);
        }
        
        function toggleUserStatus(username) {
            alert(`Toggling status for user: ${username}`);
        }
    </script>
</body>
</html>